extends layout
block content
    - var totalBTCAmt = 0
    - var totalETHAmt = 0
    - var totalLTCAmt = 0
    - var totalBCHAmt = 0
    - var totalETCAmt = 0
    - var totalXLMAmt = 0
    - var totalLINKAmt = 0
    - var totalXTZAmt = 0
    - var totalBTCValue = 0
    - var totalETHValue = 0
    - var totalLTCValue = 0
    - var totalBCHValue = 0
    - var totalETCValue = 0
    - var totalXLMValue = 0
    - var totalLINKValue = 0
    - var totalXTZValue = 0
    - var totalValue = 0
    - var totalBTCGainLoss = 0
    - var totalETHGainLoss = 0
    - var totalLTCGainLoss = 0
    - var totalBCHGainLoss = 0
    - var totalETCGainLoss = 0
    - var totalXLMGainLoss = 0
    - var totalLINKGainLoss = 0
    - var totalXTZGainLoss = 0
    - var totalGainLoss = 0
    - var totalBTCCost = 0
    - var totalETHCost = 0
    - var totalLTCCost = 0
    - var totalBCHCost = 0
    - var totalETCCost = 0
    - var totalXLMCost = 0
    - var totalLINKCost = 0
    - var totalXTZCost = 0
    - var totalReturn = 0
    - var totalCost = 0
    - for(i = 0; i < docs.length; i++){
        - var gainLoss;
        - if(docs[i].currency == 'BTC'){
            - docs[i].currentValue = Number(Math.round((Number(docs[i].amount) * Number(cBTCPrice)) + 'e2') + 'e-2');
            - docs[i].gainLoss = Number(Math.round((docs[i].currentValue - Number(docs[i].cost)) + 'e2') + 'e-2');
            - totalBTCValue += docs[i].currentValue;
            - totalBTCAmt += Number(docs[i].amount);
            - totalBTCGainLoss += docs[i].gainLoss;
            - totalBTCCost += docs[i].cost;
        - }else if(docs[i].currency == 'ETH'){
            - docs[i].currentValue = Number(Math.round((Number(docs[i].amount) * Number(cETHPrice)) + 'e2') + 'e-2');
            - docs[i].gainLoss = Number(Math.round((docs[i].currentValue - Number(docs[i].cost)) + 'e2') + 'e-2');
            - totalETHValue += docs[i].currentValue;
            - totalETHAmt += Number(docs[i].amount);
            - totalETHGainLoss += docs[i].gainLoss;
            - totalETHCost += docs[i].cost;
        - }else if(docs[i].currency == 'LTC'){
            - docs[i].currentValue = Number(Math.round((Number(docs[i].amount) * Number(cLTCPrice)) + 'e2') + 'e-2');
            - docs[i].gainLoss = Number(Math.round((docs[i].currentValue - Number(docs[i].cost)) + 'e2') + 'e-2');
            - totalLTCValue += docs[i].currentValue;
            - totalLTCAmt += Number(docs[i].amount);
            - totalLTCGainLoss += docs[i].gainLoss;
            - totalLTCCost += docs[i].cost;
        - }else if(docs[i].currency == 'BCH'){
            - docs[i].currentValue = Number(Math.round((Number(docs[i].amount) * Number(cBCHPrice)) + 'e2') + 'e-2');
            - docs[i].gainLoss = Number(Math.round((docs[i].currentValue - Number(docs[i].cost)) + 'e2') + 'e-2');
            - totalBCHValue += docs[i].currentValue;
            - totalBCHAmt += Number(docs[i].amount);
            - totalBCHGainLoss += docs[i].gainLoss;
            - totalBCHCost += docs[i].cost;
        - }else if(docs[i].currency == 'ETC'){
            - docs[i].currentValue = Number(Math.round((Number(docs[i].amount) * Number(cETCPrice)) + 'e2') + 'e-2');
            - docs[i].gainLoss = Number(Math.round((docs[i].currentValue - Number(docs[i].cost)) + 'e2') + 'e-2');
            - totalETCValue += docs[i].currentValue;
            - totalETCAmt += Number(docs[i].amount);
            - totalETCGainLoss += docs[i].gainLoss;
            - totalETCCost += docs[i].cost;
        - }else if(docs[i].currency == 'XLM'){
            - docs[i].currentValue = Number(Math.round((Number(docs[i].amount) * Number(cXLMPrice)) + 'e2') + 'e-2');
            - docs[i].gainLoss = Number(Math.round((docs[i].currentValue - Number(docs[i].cost)) + 'e2') + 'e-2');
            - totalXLMValue += docs[i].currentValue;
            - totalXLMAmt += Number(docs[i].amount);
            - totalXLMGainLoss += docs[i].gainLoss;
            - totalXLMCost += docs[i].cost;
        - }else if(docs[i].currency == 'LINK'){
            - docs[i].currentValue = Number(Math.round((Number(docs[i].amount) * Number(cLINKPrice)) + 'e2') + 'e-2');
            - docs[i].gainLoss = Number(Math.round((docs[i].currentValue - Number(docs[i].cost)) + 'e2') + 'e-2');
            - totalLINKValue += docs[i].currentValue;
            - totalLINKAmt += Number(docs[i].amount);
            - totalLINKGainLoss += docs[i].gainLoss;
            - totalLINKCost += docs[i].cost;
        - }else if(docs[i].currency == 'XTZ'){
            - docs[i].currentValue = Number(Math.round((Number(docs[i].amount) * Number(cXTZPrice)) + 'e2') + 'e-2');
            - docs[i].gainLoss = Number(Math.round((docs[i].currentValue - Number(docs[i].cost)) + 'e2') + 'e-2');
            - totalXTZValue += docs[i].currentValue;
            - totalXTZAmt += Number(docs[i].amount);
            - totalXTZGainLoss += docs[i].gainLoss;
            - totalXTZCost += docs[i].cost;
        - }

        - totalValue += docs[i].currentValue;
        - totalCost += docs[i].cost;
        - totalGainLoss += docs[i].gainLoss;
    - }
                
    .container
        div
            div(style="float: right")
                a(href="logout") Logout
            h2 Summary
            table.table.table-striped
                thead.thead-default
                    tr
                        th Currency
                        th Amount
                        th Value
                        th Gain/Loss
                        th Return
                - if(totalBTCAmt > 0){
                tr
                    td BTC
                    td #{totalBTCAmt.toFixed(8)}
                    td $#{totalBTCValue.toFixed(2)}
                    - if(totalBTCGainLoss < 0){
                        td.loss $#{totalBTCGainLoss.toFixed(2)}
                    - }else if(totalBTCGainLoss > 0){
                        td.gain $#{totalBTCGainLoss.toFixed(2)}
                    - }else{
                        td $#{totalBTCGainLoss.toFixed(2)}
                    - }
                    - if(((totalBTCGainLoss / totalBTCCost)*100) < 0){
                        td.loss #{((totalBTCGainLoss / totalBTCCost)*100).toFixed(2)}%
                    - }else if(((totalBTCGainLoss / totalBTCCost)*100) > 0){
                        td.gain #{((totalBTCGainLoss / totalBTCCost)*100).toFixed(2)}%
                    - }else{
                        - totalBTCCost = totalBTCCost == 0 ? 1 : totalBTCCost;
                        td #{((totalBTCGainLoss / totalBTCCost)*100).toFixed(2)}%
                    - }
                - }
                - if(totalETHAmt > 0){
                tr
                    td ETH
                    td #{totalETHAmt.toFixed(8)}
                    td $#{totalETHValue.toFixed(2)}
                    - if(totalETHGainLoss < 0){
                        td.loss $#{totalETHGainLoss.toFixed(2)}
                    - }else if(totalETHGainLoss > 0){
                        td.gain $#{totalETHGainLoss.toFixed(2)}
                    - }else{
                        td $#{totalETHGainLoss.toFixed(2)}
                    - }
                    - if(((totalETHGainLoss / totalETHCost)*100) < 0){
                        td.loss #{((totalETHGainLoss / totalETHCost)*100).toFixed(2)}%
                    - }else if(((totalETHGainLoss / totalETHCost)*100) > 0){
                        td.gain #{((totalETHGainLoss / totalETHCost)*100).toFixed(2)}%
                    - }else{
                        - totalETHCost = totalETHCost == 0 ? 1 : totalETHCost;
                        td #{((totalETHGainLoss / totalETHCost)*100).toFixed(2)}%
                    - }
                - }
                - if(totalLTCAmt > 0){
                tr
                    td LTC
                    td #{totalLTCAmt.toFixed(8)}
                    td $#{totalLTCValue.toFixed(2)}
                    - if(totalLTCGainLoss < 0){
                        td.loss $#{totalLTCGainLoss.toFixed(2)}
                    - }else if(totalLTCGainLoss > 0){
                        td.gain $#{totalLTCGainLoss.toFixed(2)}
                    - }else{
                        td $#{totalLTCGainLoss.toFixed(2)}
                    - }
                    - if(((totalLTCGainLoss / totalLTCCost)*100) < 0){
                        td.loss #{((totalLTCGainLoss / totalLTCCost)*100).toFixed(2)}%
                    - }else if(((totalLTCGainLoss / totalLTCCost)*100) > 0){
                        td.gain #{((totalLTCGainLoss / totalLTCCost)*100).toFixed(2)}%
                    - }else{
                        - totalLTCCost = totalLTCCost == 0 ? 1 : totalLTCCost;
                        td #{((totalLTCGainLoss / totalLTCCost)*100).toFixed(2)}%
                    - }
                - }
                - if(totalBCHAmt > 0){
                tr
                    td BCH
                    td #{totalBCHAmt.toFixed(8)}
                    td $#{totalBCHValue.toFixed(2)}
                    - if(totalBCHGainLoss < 0){
                        td.loss $#{totalBCHGainLoss.toFixed(2)}
                    - }else if(totalBCHGainLoss > 0){
                        td.gain $#{totalBCHGainLoss.toFixed(2)}
                    - }else{
                        td $#{totalBCHGainLoss.toFixed(2)}
                    - }
                    - if(((totalBCHGainLoss / totalBCHCost)*100) < 0){
                        td.loss #{((totalBCHGainLoss / totalBCHCost)*100).toFixed(2)}%
                    - }else if(((totalBCHGainLoss / totalBCHCost)*100) > 0){
                        td.gain #{((totalBCHGainLoss / totalBCHCost)*100).toFixed(2)}%
                    - }else{
                        - totalBCHCost = totalBCHCost == 0 ? 1 : totalBCHCost;
                        td #{((totalBCHGainLoss / totalBCHCost)*100).toFixed(2)}%
                    - }
                - }
                - if(totalETCAmt > 0){
                tr
                    td ETC
                    td #{totalETCAmt.toFixed(8)}
                    td $#{totalETCValue.toFixed(2)}
                    - if(totalETCGainLoss < 0){
                        td.loss $#{totalETCGainLoss.toFixed(2)}
                    - }else if(totalETCGainLoss > 0){
                        td.gain $#{totalETCGainLoss.toFixed(2)}
                    - }else{
                        td $#{totalETCGainLoss.toFixed(2)}
                    - }
                    - if(((totalETCGainLoss / totalETCCost)*100) < 0){
                        td.loss #{((totalETCGainLoss / totalETCCost)*100).toFixed(2)}%
                    - }else if(((totalETCGainLoss / totalETCCost)*100) > 0){
                        td.gain #{((totalETCGainLoss / totalETCCost)*100).toFixed(2)}%
                    - }else{
                        - totalETCCost = totalETCCost == 0 ? 1 : totalETCCost;
                        td #{((totalETCGainLoss / totalETCCost)*100).toFixed(2)}%
                    - }
                - }
                - if(totalXLMAmt > 0){
                tr
                    td XLM
                    td #{totalXLMAmt.toFixed(8)}
                    td $#{totalXLMValue.toFixed(2)}
                    - if(totalXLMGainLoss < 0){
                        td.loss $#{totalXLMGainLoss.toFixed(2)}
                    - }else if(totalXLMGainLoss > 0){
                        td.gain $#{totalXLMGainLoss.toFixed(2)}
                    - }else{
                        td $#{totalXLMGainLoss.toFixed(2)}
                    - }
                    - if(((totalXLMGainLoss / totalXLMCost)*100) < 0){
                        td.loss #{((totalXLMGainLoss / totalXLMCost)*100).toFixed(2)}%
                    - }else if(((totalXLMGainLoss / totalXLMCost)*100) > 0){
                        td.gain #{((totalXLMGainLoss / totalXLMCost)*100).toFixed(2)}%
                    - }else{
                        - totalXLMCost = totalXLMCost == 0 ? 1 : totalXLMCost;
                        td #{((totalXLMGainLoss / totalXLMCost)*100).toFixed(2)}%
                    - }
                - }
                - if(totalLINKAmt > 0){
                tr
                    td LINK
                    td #{totalLINKAmt.toFixed(8)}
                    td $#{totalLINKValue.toFixed(2)}
                    - if(totalLINKGainLoss < 0){
                        td.loss $#{totalLINKGainLoss.toFixed(2)}
                    - }else if(totalLINKGainLoss > 0){
                        td.gain $#{totalLINKGainLoss.toFixed(2)}
                    - }else{
                        td $#{totalLINKGainLoss.toFixed(2)}
                    - }
                    - if(((totalLINKGainLoss / totalLINKCost)*100) < 0){
                        td.loss #{((totalLINKGainLoss / totalLINKCost)*100).toFixed(2)}%
                    - }else if(((totalLINKGainLoss / totalLINKCost)*100) > 0){
                        td.gain #{((totalLINKGainLoss / totalLINKCost)*100).toFixed(2)}%
                    - }else{
                        - totalLINKCost = totalLINKCost == 0 ? 1 : totalLINKCost;
                        td #{((totalLINKGainLoss / totalLINKCost)*100).toFixed(2)}%
                    - }
                - }
                - if(totalXTZAmt > 0){
                tr
                    td XTZ
                    td #{totalXTZAmt.toFixed(8)}
                    td $#{totalXTZValue.toFixed(2)}
                    - if(totalXTZGainLoss < 0){
                        td.loss $#{totalXTZGainLoss.toFixed(2)}
                    - }else if(totalXTZGainLoss > 0){
                        td.gain $#{totalXTZGainLoss.toFixed(2)}
                    - }else{
                        td $#{totalXTZGainLoss.toFixed(2)}
                    - }
                    - if(((totalXTZGainLoss / totalXTZCost)*100) < 0){
                        td.loss #{((totalXTZGainLoss / totalXTZCost)*100).toFixed(2)}%
                    - }else if(((totalXTZGainLoss / totalXTZCost)*100) > 0){
                        td.gain #{((totalXTZGainLoss / totalXTZCost)*100).toFixed(2)}%
                    - }else{
                        - totalXTZCost = totalXTZCost == 0 ? 1 : totalXTZCost;
                        td #{((totalXTZGainLoss / totalXTZCost)*100).toFixed(2)}%
                    - }
                - }
                tr
                    td All 
                    td &nbsp;
                    td $#{totalValue.toFixed(2)}
                    - if(totalGainLoss < 0){
                        td.loss $#{totalGainLoss.toFixed(2)}
                    - }else if(totalGainLoss > 0){
                        td.gain $#{totalGainLoss.toFixed(2)}
                    - }else{
                        td $#{totalGainLoss.toFixed(2)}
                    - }
                    - if(((totalGainLoss / totalCost)*100) < 0){
                        td.loss #{((totalGainLoss / totalCost)*100).toFixed(2)}%
                    - }else if(((totalGainLoss / totalCost)*100) > 0){
                        td.gain #{((totalGainLoss / totalCost)*100).toFixed(2)}%
                    - }else{
                        - totalCost = totalCost == 0 ? 1 : totalCost;
                        td #{((totalGainLoss / totalCost)*100).toFixed(2)}%
                    - }

            h2 Transactions
            input(class="newTxButton" type="button" value="New Transaction")
            select(id="currencyDisplay" name="currencyDisplay").form-control
                option(selected="selected") All
                - if(totalBTCAmt > 0){
                option BTC
                - }
                - if(totalETHAmt > 0){
                option ETH
                - }
                - if(totalLTCAmt > 0){
                option LTC
                - }
                - if(totalBCHAmt > 0){
                option BCH
                - }
                - if(totalETCAmt > 0){
                option ETC 
                - }
                - if(totalXLMAmt > 0){
                option XLM
                - }
                - if(totalLINKAmt > 0){
                option LINK
                - }
                - if(totalXTZAmt > 0){
                option XTZ
                - }
            table.table.table-striped
                thead.thead-default
                    tr
                        th Time
                        th Currency
                        th Type
                        th Amount
                        th Cost
                        th Current Value
                        th Gain/Loss
                - for(i = 0; i < docs.length; i++){
                    tr(class=docs[i].currency + "_row")
                        td.hidden.rowEditId #{docs[i]._id}
                        td.rowEditTime #{docs[i].time}
                        td.rowEditCurrency #{docs[i].currency}
                        td.rowEditType #{docs[i].type}
                        td.rowEditAmount #{docs[i].amount}
                        td.rowEditCost $#{docs[i].cost.toFixed(2)}
                        td $#{docs[i].currentValue.toFixed(2)}
                        - if(docs[i].gainLoss < 0){
                            td.loss $#{docs[i].gainLoss.toFixed(2)}
                        - }else if(docs[i].gainLoss > 0){
                            td.gain $#{docs[i].gainLoss.toFixed(2)}
                        - }else{
                            td $#{docs[i].gainLoss.toFixed(2)}
                        - }
                        td 
                            span.editRow.glyphicon.glyphicon-pencil
                            span.removeRow.glyphicon.glyphicon-remove.hidden
                - }
                
        div(id="newTxDialog" title="New Transaction")
            div(id="formError" style="display: none;")
                
            form(action="/add" method="post")
                label Time and Date:
                input(id="time" name="time" type="text").textInput
                label Currency:
                select(id="currency" name="currency").form-control
                    option(selected="selected") BTC
                    option ETH
                    option LTC
                    option BCH
                    option ETC
                    option XLM
                    option LINK
                    option XTZ
                label Type:
                select(id="type" name="type").form-control
                    option(selected="selected") buy
                    option sell
                label Amount:
                input(id="amount" name="amount" type="text").textInput
                label(id="costProceeds") Cost:
                input(id="cost" name="cost" type="text").textInput
                input(id="submit" class="submit" type="submit" value="Add")
        
        div(id="editTxDialog" title="Edit Transaction")
            div(id="editFormError" style="display: none;")
                
            form(action="/edit" method="post")
                input(id="editid" name="id").textInput.hidden
                label Time and Date:
                input(id="edittime" name="time" type="text").textInput
                label Currency:
                select(id="editcurrency" name="currency").form-control
                    option(selected="selected") BTC
                    option ETH
                    option LTC
                    option BCH
                    option ETC
                    option XLM
                    option LINK
                    option XTZ
                label Type:
                select(id="edittype" name="type").form-control
                    option(selected="selected") buy
                    option sell
                label Amount:
                input(id="editamount" name="amount" type="text").textInput
                label(id="editCostProceeds") Cost:
                input(id="editcost" name="cost" type="text").textInput
                input(id="editsubmit" class="submit" type="submit" value="Save")

        input(class="newTxButton" type="button" value="New Transaction")

    script.
        $(document).ready(function(){
            $(function(){
                $('#newTxDialog').dialog({
                    autoOpen: false
                });

                $('#editTxDialog').dialog({
                    autoOpen: false
                });

                $('.editRow').on('click', function(){
                    $('#formError, #editFormError').hide();
                    $("#editid").val($(".rowEditId", $(this).closest("tr")).html());
                    $("#edittime").val($(".rowEditTime", $(this).closest("tr")).html());
                    $("#editcurrency").val($(".rowEditCurrency", $(this).closest("tr")).html());
                    $("#edittype").val($(".rowEditType", $(this).closest("tr")).html());
                    $("#editamount").val($(".rowEditAmount", $(this).closest("tr")).html());
                    $("#editcost").val($(".rowEditCost", $(this).closest("tr")).html());

                    $('#editTxDialog').dialog('open');
                });

                $('.removeRow').on('click', function(){
                    console.log(this.id);
                    return;
                });

                $('#time, #edittime').keyup(function(){
                    var timeVal = $(this).val(); 
                        if(timeVal.match(/^[0-9]{4}$/)){
                            $(this).val(timeVal + '-');
                        }else if(timeVal.match(/^[0-9]{4}-[0-1][0-9]$/)){
                            $(this).val(timeVal + '-');
                        }else if(timeVal.match(/^[0-9]{4}-[0-1][0-9]-[0-3][0-9]$/)){
                            $(this).val(timeVal + ' ');
                        }else if(timeVal.match(/^[0-9]{4}-[0-1][0-9]-[0-3][0-9] [0-2][0-9]$/)){
                            $(this).val(timeVal + ':');
                        }else if(timeVal.match(/^[0-9]{4}-[0-1][0-9]-[0-3][0-9] [0-2][0-9]:[0-5][0-9]$/)){
                            $(this).val(timeVal + ':');
                        }else{
                            $(this).val(timeVal);
                        }
                });

                $('#type, #edittype').change(function(){
                    var value = $(this).val();
                    if(value == 'buy'){
                        $('#costProceeds, #editCostProceeds').html('Cost:').change();
                    }else if(value == 'sell'){  
                        $('#costProceeds, #editCostProceeds').html('Proceeds:').change();
                    }
                });

                $('.newTxButton').on('click', function(){
                    $('#newTxDialog').dialog('open');
                });

                $('#currencyDisplay').on('change', function(){
                   var rowClass = $('#currencyDisplay').val() + '_row';
                   var rowClasses = ['BTC_row', 'ETH_row', 'LTC_row', 'BCH_row', 'ETC_row', 'XLM_row', 'LINK_row', 'XTZ_row'];
                   if(rowClass == 'All_row'){
                       $('.BTC_row').show();
                       $('.LTC_row').show();
                       $('.ETH_row').show();
                       $('.BCH_row').show();
                       $('.ETC_row').show();
                       $('.XLM_row').show();
                       $('.LINK_row').show();
                       $('.XTZ_row').show();
                   }else{
                       $('.'+rowClass).show();
                       for(i=0; i<rowClasses.length; i++){
                            if(rowClass != rowClasses[i]){
                                $('.'+rowClasses[i]).hide();
                            }
                        }
                   }
                });
            });

            $('#submit').click(function(e){
                var time = $('#time').val();
                var amount = $('#amount').val();
                var cost = $('#cost').val();
                var timeReg = /^[0-9]{4}-[0-1][0-9]-[0-3][0-9] [0-2][0-9]:[0-5][0-9]:[0-5][0-9]$/;
                if(!time || !amount || !cost){
                    e.preventDefault();
                    $('#formError').html('<span>All fields are required.</span>');
                    $('#formError').show('fast');
                }
                if(!(time).match(timeReg)){
                    e.preventDefault();
                    $('#formError').html('<span>Time must be in YYYY-MM-DD HH:MM:SS format.</span>');
                    $('#formError').show('fast');
                }
            });
            $('#editsubmit').click(function(e){
                var time = $('#edittime').val();
                var amount = $('#editamount').val();
                var cost = $('#editcost').val();
                var timeReg = /^[0-9]{4}-[0-1][0-9]-[0-3][0-9] [0-2][0-9]:[0-5][0-9]:[0-5][0-9]$/;
                if(!time || !amount || !cost){
                    e.preventDefault();
                    $('#editFormError').html('<span>All fields are required.</span>');
                    $('#editFormError').show('fast');
                }
                if(!(time).match(timeReg)){
                    e.preventDefault();
                    $('#editFormError').html('<span>Time must be in YYYY-MM-DD HH:MM:SS format.</span>');
                    $('#editFormError').show('fast');
                }
            });
        });
